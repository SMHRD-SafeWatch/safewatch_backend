<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modal 예제</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmpeg/0.1/jsmpg.js"></script>
  <style>
    #video-canvas {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 한 행에 3개의 비디오 */
        gap: 10px;
    }
    #pagination-controls {
        margin-top: 20px;
        text-align: center;
    }
  </style>
  <link rel="stylesheet" href="/css/streamModal.css">
</head>
<body>

<div id="video-canvas" style="width:700px"></div>
<div id="pagination-controls">
  <button id="prev-button">이전</button>
  <span id="page-info"></span>
  <button id="next-button">다음</button>
</div>

<!-- Modal 구조 -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>모달 제목</h2>
    <div id="video"></div>
  </div>
</div>

<script> // 모달 열기
  let portList = [];

  // 데이터를 가져오는 함수
  async function fetchCameraData() {
    try {
      // API 요청
      const response = await fetch('http://localhost:8084/api/portget');
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      // JSON 데이터로 변환
      const cameras = await response.json();

      portList = cameras.map(camera => ({ wsPort: camera.port }));
      renderVideos(); // 데이터가 로드된 후 비디오 렌더링
    } catch (error) {
      console.error('Error fetching camera data:', error);
    }
  }

  // 페이지가 로드되면 데이터 가져오기
  window.onload = fetchCameraData;

  const modal = document.getElementById("myModal");
  const span = document.getElementsByClassName("close")[0];

  let modal_player = null;
  let modal_client = null;
  const modal_video = document.getElementById("video");

  function clickModal(port) {
      if (modal_player) {
          modal_player.stop();
          modal_player = null;
      }
      if (modal_client) {
          modal_client.close();
          modal_client = null;
      }
      modal_video.innerHTML = '';

      const stream_video = document.createElement('canvas');
      stream_video.id = 'canvasModal';
      stream_video.width = 640;
      stream_video.height = 480;
      modal_video.appendChild(stream_video);

      modal_client = new WebSocket('ws://localhost:' + port);
      modal_player = new jsmpeg(modal_client, { canvas: stream_video });
      modal.style.display = "block";
  }

  // 모달 닫기 (X 버튼 클릭 시)
  span.onclick = function() {
      if (modal_player) {
          modal_player.stop();
          modal_player = null;
      }
      if (modal_client) {
          modal_client.close();
          modal_client = null;
      }
      modal_video.innerHTML = '';
      modal.style.display = "none";
  }

  // 모달 닫기 (모달 외부 클릭 시)
  window.onclick = function(event) {
      if (event.target == modal) {
          modal.style.display = "none";
          if (modal_player) {
              modal_player.stop();
              modal_player = null;
          }
          if (modal_client) {
              modal_client.close();
              modal_client = null;
          }
          modal_video.innerHTML = '';
      }
  }

  let currentPage = 1;
  const itemsPerPage = 6;
  const container = document.getElementById('video-canvas');

  let players = [];
  let clients = [];

  function renderVideos() {
      container.innerHTML = '';
      if (players.length > 0) {
          players.forEach(player => player.stop());
          players = [];
      }
      if (clients.length > 0) {
          clients.forEach(client => client.close());
          clients = [];
      }

      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const currentItems = portList.slice(startIndex, endIndex);

      currentItems.forEach((portObj, index) => {
          const canvas = document.createElement('canvas');
          canvas.id = 'canvas' + index;
          canvas.style.width = "200px";
          canvas.style.height = "200px";
          canvas.onclick = function() {
              clickModal(portObj.wsPort);
          };
          container.appendChild(canvas);

          const client = new WebSocket('ws://localhost:' + portObj.wsPort);
          clients.push(client);

          const player = new jsmpeg(client, {
              canvas: canvas,
          });
          players.push(player);
      });

      updatePageInfo();
  }

  function updatePageInfo() {
      const pageInfo = document.getElementById('page-info');
      const totalPages = Math.ceil(portList.length / itemsPerPage);
      pageInfo.textContent = `페이지 ${currentPage} / ${totalPages}`;
  }

  document.getElementById('prev-button').addEventListener('click', () => {
      if (currentPage > 1) {
          currentPage--;
          renderVideos();
      }
  });

  document.getElementById('next-button').addEventListener('click', () => {
      const totalPages = Math.ceil(portList.length / itemsPerPage);
      if (currentPage < totalPages) {
          currentPage++;
          renderVideos();
      }
  });

</script>

</body>
</html>
